<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>마비노기 꽃길 길드팟</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; padding: 20px; margin: 0; }
    form, select, input, button { width: 100%; max-width: 500px; margin: 5px auto; display: block; }
    .dungeon-section { margin-top: 30px; border-top: 1px solid #ccc; padding-top: 20px; }
    .role-dps { background-color: #FFD1B3; padding: 2px 5px; border-radius: 4px; }
    .role-heal { background-color: #C2F0C2; padding: 2px 5px; border-radius: 4px; }
    .role-tank { background-color: #C2E0FF; padding: 2px 5px; border-radius: 4px; }
    .party-block { margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
    ul { padding-left: 20px; }
    li { margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
    .inline-btn { width: 22px; height: 22px; font-size: 12px; line-height: 20px; text-align: center; padding: 0; margin-left: 10px; background: #eee; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; }
    .match-buttons { display: flex; gap: 10px; margin-top: 10px; justify-content: center; flex-wrap: wrap; }
    .match-buttons button { flex: 1; min-width: 120px; padding: 6px 10px; font-size: 0.9em; }
    @media screen and (max-width: 600px) { input, select, button { width: 100%; margin: 5px 0; } .match-buttons { flex-direction: column; } }
  </style>
</head>
<body>
  <h1 style="text-align:center">마비노기 꽃길 길드팟</h1>
  <form id="partyForm">
    <label>던전:</label>
    <select id="dungeon">
      <option value="어비스">어비스</option>
      <option value="레이드">레이드</option>
    </select>
    <label>난이도:</label>
    <select id="difficulty"></select>
    <label>닉네임:</label>
    <input type="text" id="name" required>
    <label>직업:</label>
    <input type="text" id="job" required>
    <label>역할:</label>
    <select id="role">
      <option value="딜러">딜러</option>
      <option value="힐러">힐러</option>
      <option value="탱커">탱커</option>
    </select>
    <label>특이사항 (선택):</label>
    <input type="text" id="note" placeholder="없으면 비워두세요">
    <button type="submit">신청</button>
  </form>
  <div id="dungeonSections"></div>
  <script>
    // Firebase 설정 및 초기화
    const firebaseConfig = {
      apiKey: "AIzaSyColXLlJbXM6x97A4j1ME8QWNKTheAccFM",
      authDomain: "mabinogim-flowerroad-party.firebaseapp.com",
      databaseURL: "https://mabinogim-flowerroad-party-default-rtdb.firebaseio.com",
      projectId: "mabinogim-flowerroad-party",
      storageBucket: "mabinogim-flowerroad-party.appspot.com",
      messagingSenderId: "1051963693734",
      appId: "1:1051963693734:web:c264607ec4ecf562147267"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 설정 데이터
    const dungeonConfigs = {
      어비스: { difficulties: ['입문', '어려움', '매우어려움'], partySize: 4 },
      레이드: { difficulties: ['입문'], partySize: 8 }
    };
    const matchedParties = {};

    // DOM 참조
    const form = document.getElementById('partyForm');
    const dungeonSelect = document.getElementById('dungeon');
    const difficultySelect = document.getElementById('difficulty');
    const sectionsContainer = document.getElementById('dungeonSections');

    // 난이도 업데이트
    function updateDifficultyOptions() {
      const cfg = dungeonConfigs[dungeonSelect.value];
      difficultySelect.innerHTML = '';
      cfg.difficulties.forEach(diff => {
        const opt = document.createElement('option');
        opt.value = diff;
        opt.textContent = diff;
        difficultySelect.appendChild(opt);
      });
      if (dungeonSelect.value === '어비스') difficultySelect.value = '매우어려움';
    }
    dungeonSelect.addEventListener('change', updateDifficultyOptions);
    updateDifficultyOptions();

    // 배열 셔플
    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }

    // 신청자 추가
    form.addEventListener('submit', e => {
      e.preventDefault();
      const key = `${dungeonSelect.value}_${difficultySelect.value}`;
      const ref = db.ref(`parties/${key}`).push();
      ref.set({
        name: document.getElementById('name').value,
        job: document.getElementById('job').value,
        role: document.getElementById('role').value,
        note: document.getElementById('note').value,
        id: ref.key
      });
      form.reset();
      updateDifficultyOptions();
    });

    // 섹션 렌더링
    function renderSection(key, list) {
      let sec = document.getElementById(`section-${key}`);
      if (!sec) {
        sec = document.createElement('div');
        sec.id = `section-${key}`;
        sec.className = 'dungeon-section';
        sec.innerHTML = `
          <h2>${key.replace('_', ' - ')} (<span id="${key}-count">0</span>명 신청)</h2>
          <ul id="${key}-list"></ul>
          <div class="match-buttons">
            <button onclick="match('${key}', ${dungeonConfigs[key.split('_')[0]].partySize})">파티 자동 매칭</button>
          </div>
          <div id="${key}-matched"></div>`;
        sectionsContainer.appendChild(sec);
      }
      const ul = document.getElementById(`${key}-list`);
      const cnt = document.getElementById(`${key}-count`);
      const remaining = list.filter(p => !matchedParties[key]?.flat().map(m => m.id).includes(p.id));
      cnt.textContent = remaining.length;
      ul.innerHTML = '';
      remaining.forEach((p, i) => {
        const noteStr = p.note ? ` - [${p.note}]` : '';
        const li = document.createElement('li');
        li.innerHTML = `${i + 1}. <span class="role-${p.role === '딜러' ? 'dps' : p.role === '힐러' ? 'heal' : 'tank'}">${p.name} (${p.job}) ${p.role}${noteStr}</span><button class="inline-btn" onclick="removeApplicant('${key}','${p.id}')">❌</button>`;
        ul.appendChild(li);
      });
    }
    window.renderSection = renderSection;

    function removeApplicant(key, id) {
      db.ref(`parties/${key}/${id}`).remove();
    }
    window.removeApplicant = removeApplicant;

    function renderMatched(key) {
      const box = document.getElementById(`${key}-matched`);
      const parts = matchedParties[key] || [];
      if (!parts.length) return box.innerHTML = '<p>매칭된 파티 없음</p>';
      box.innerHTML = parts.map((party, i) => {
        const membersHtml = party.map(p => {
          const tag = `<span class="role-${p.role === '딜러' ? 'dps' : p.role === '힐러' ? 'heal' : 'tank'}">${p.name} (${p.job})</span>`;
          return p.note ? `${tag} - [${p.note}]` : tag;
        }).join(', ');
        return `<div class="party-block"><strong>파티 ${i + 1}</strong>: ${membersHtml}<button class="inline-btn" onclick="deleteParty('${key}',${i})">❌</button></div>`;
      }).join('');
    }
    window.renderMatched = renderMatched;

    function deleteParty(key, idx) {
      const p = matchedParties[key].splice(idx, 1)[0];
      p.forEach(m => db.ref(`parties/${key}/${m.id}`).set(m));
      db.ref(`matchedParties/${key}`).set(matchedParties[key]);
    }
    window.deleteParty = deleteParty;

    // 자동 매칭
    function match(key, size) {
      const partiesRef = db.ref(`parties/${key}`);
      const matchedRef = db.ref(`matchedParties/${key}`);
      // 복원 및 초기화
      matchedRef.set([]).then(() => {
        return partiesRef.once('value');
      }).then(snap => {
        let mems = Object.values(snap.val() || {});
        shuffle(mems);
        const isRaid = size === 8;
        const newMatched = [];
        while (mems.length >= size) {
          const party = [];
          const ns = new Set();
          const counts = { 탱커: isRaid ? 2 : 1, 힐러: isRaid ? 2 : 1 };
          ['탱커', '힐러'].sort(() => Math.random() - 0.5).forEach(r => {
            mems.filter(m => m.role === r).forEach(p => {
              if (party.length < size && counts[r] > 0) {
                party.push(p); ns.add(p.name); counts[r]--;
              }
            });
          });
          mems.filter(m => !ns.has(m.name) && m.role === '딜러').forEach(p => {
            if (party.length < size) { party.push(p); ns.add(p.name); }
          });
          mems.filter(m => !ns.has(m.name) && m.role !== '딜러').sort(() => Math.random() - 0.5).forEach(p => {
            if (party.length < size) { party.push(p); ns.add(p.name); }
          });
          if (party.length === size) { newMatched.push(party); mems = mems.filter(m => !ns.has(m.name)); } else break;
        }
        matchedParties[key] = newMatched;
        return matchedRef.set(newMatched);
      }).then(() => {
        return partiesRef.once('value');
      }).then(snap => {
        const removes = matchedParties[key].flat().map(p => db.ref(`parties/${key}/${p.id}`).remove());
        return Promise.all(removes);
      }).then(() => {
        renderMatched(key);
      }).catch(err => console.error(err));
    }
    window.match = match;

    // 리스너 등록
    Object.keys(dungeonConfigs).forEach(d => {
      dungeonConfigs[d].difficulties.forEach(diff => {
        const key = `${d}_${diff}`;
        db.ref(`parties/${key}`).on('value', snap => {
          const list = snap.val() ? Object.entries(snap.val()).map(([id, v]) => ({ ...v, id })) : [];
          renderSection(key, list);
        });
        db.ref(`matchedParties/${key}`).on('value', snap => {
          matchedParties[key] = snap.val() || [];
          renderMatched(key);
        });
      });
    });
  </script>
</body>
</html>
